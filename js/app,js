$(document).ready(function () {
    const $galleryContainer = $('#gallery-container');
    const $loadingIndicator = $('.loading-indicator');
    const itemSelector = '.grid-item';

    // Exibir o indicador de carregamento
    $loadingIndicator.show();

    function verificarImagem(src) {
        return src;
    }

    // Carregar o JSON e adicionar as imagens ao container
    $.getJSON('json/photos.json')
        .done(function (data) {
            console.log(`Carregando ${data.length} imagens do JSON`);

            $.each(data, function (index, item) {
                const imgSrc = verificarImagem(item.src);
                const imageHTML = `
                    <div class="grid-item ${item.filter}" data-filter="${item.filter}">
                        <a class="popupimg" href="${imgSrc}" aria-label="Ver foto de ${item.name} em tamanho ampliado">
                            <img src="${imgSrc}" alt="${item.name}" />
                        </a>
                        <div class="overlay">${item.name}</div>
                    </div>
                `;
                $galleryContainer.append(imageHTML);
            });

            // Inicializar a galeria após o carregamento de todas as imagens
            $galleryContainer.imagesLoaded(function () {
                $galleryContainer.isotope({
                    itemSelector: itemSelector,
                    layoutMode: 'masonry',
                    masonry: {
                        columnWidth: itemSelector,
                        gutter: 15,
                        isFitWidth: true
                    }
                });
                
                $loadingIndicator.hide();

                // Chamar o Magnific Popup
                setupImageViewer();
            });
        })
        .fail(function (jqxhr, textStatus, error) {
            console.error("Erro ao carregar o JSON:", textStatus, error);
            $loadingIndicator.hide();
            $galleryContainer.html('<div class="error-message">Não foi possível carregar as imagens. Por favor, tente novamente mais tarde.</div>');
        });

    // Função para configurar o visualizador de imagens (Magnific Popup)
    function setupImageViewer() {
        $('.popupimg').off('click');
        $('.grid-item').each(function (index) {
            const $item = $(this);
            const $link = $item.find('a.popupimg');
            $link.attr('data-index', index);
            $link.on('click', function (e) {
                e.preventDefault();
                const visibleLinks = $('.grid-item:not(.isotope-hidden) .popupimg');
                const items = [];
                visibleLinks.each(function () {
                    const href = $(this).attr('href');
                    const title = $(this).closest('.grid-item').find('.overlay').text();
                    items.push({ src: href, title: title });
                });
                const currentIndex = visibleLinks.index($(this));
                $.magnificPopup.open({
                    items: items,
                    type: 'image',
                    gallery: {
                        enabled: true,
                        navigateByImgClick: true,
                        preload: [0, 1]
                    }
                }, currentIndex);
            });
        });
    }

});